<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Webrtcgame : " />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">
<script src="jquery-2.0.1.min.js"></script>
    <title>Webrtcgame</title>
  </head>

  <body>


    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/WebRTCGame/WebRTCGame">View on GitHub</a>

          <h1 id="project_title">Webrtcgame</h1>
          <h2 id="project_tagline"></h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/WebRTCGame/WebRTCGame/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/WebRTCGame/WebRTCGame/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h3>
<div class="headerBar">
<button class="buttonHost">Host</button><button class="buttonJoin">Join</button>
</div>


      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Webrtcgame maintained by <a href="https://github.com/WebRTCGame">WebRTCGame</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    
<div>
	
    <script src="https://rawgithub.com/WebRTCGame/WebRTCGame/master/files/peer.min.js"></script>
    <script src="https://rawgithub.com/WebRTCGame/WebRTCGame/master/files/mux.js"></script>
    <script src="https://rawgithub.com/WebRTCGame/WebRTCGame/master/files/app.js"></script>
    <script src="https://rawgithub.com/WebRTCGame/WebRTCGame/master/files/key.js"></script>
	
<script>
    //var key = 'lz6yk6yy4tg74x6r';
var key = 'kmjpk4hdea5rk9';

    var canvas;
    var ctx;
    var ballSpeed = 3
    var paddle0Pos = 480/2;
    var paddle1Pos = 480/2;
    var lastPaddle0Pos = 480/2;
    var lastPaddle1Pos = 480/2;
    var ballPos = {x:640/2,y: 480/2};
    var lastBallPos = {x:640/2,y: 480/2};
    var paddleWidth = 100;
    var ballWidth = 10;
    var ballVelocity = {x:ballSpeed,y:0};

    var player0Score = 0;
    var player1Score = 0;
    var score = player0Score + "   :   " + player1Score;

    if(Math.floor( Math.random() * 2 ) == 1){
        ballVelocity = {x:-ballSpeed,y:0};
    }
    ballVelocity.y = Math.random()*ballSpeed-ballSpeed/2;

    var renderPong = function(){
        ctx.fillStyle = 'white';
        ctx.fillRect(0,0,640,480);
        ctx.fillStyle = 'red';
        ctx.fillRect(20,paddle0Pos-paddleWidth/2,10,paddleWidth);

        ctx.fillStyle = 'red';
        ctx.fillRect(640-30,paddle1Pos-paddleWidth/2,10,paddleWidth);

        ctx.fillStyle = 'green';
        ctx.fillRect(ballPos.x-ballWidth/2,ballPos.y-ballWidth/2,ballWidth,ballWidth);

        ctx.fillStyle = "blue";
        ctx.fillText(score,640/2-50,20);
    };

    var hitPaddle = function(){
        if( ballPos.x >= 20 && ballPos.y >= paddle0Pos-paddleWidth/2 &&  ballPos.x < 20+10 && ballPos.y < paddle0Pos-paddleWidth/2+paddleWidth){
            return true;
        }

        if( ballPos.x >= 640-30 && ballPos.y >= paddle1Pos-paddleWidth/2 &&  ballPos.x < 640-30+10 && ballPos.y < paddle1Pos-paddleWidth/2+paddleWidth){
            return true;
        }

        return false;
    }

    var startServer = function(){
        var run = function(){
            renderPong();
            if(Key.isDown(Key.DOWN_ARROW)){
                paddle0Pos += 2;
            }
            if(Key.isDown(Key.UP_ARROW)){
                paddle0Pos -= 2;
            }
            paddle0Pos = Math.max(paddle0Pos,0);
            paddle0Pos = Math.min(paddle0Pos,640);


            tempBallPos = {x:ballPos.x,y:ballPos.y};

            ballPos.x += ballVelocity.x;
            ballPos.y += ballVelocity.y;

            if(ballPos.x > 640 || ballPos.x <0){
                if(ballPos.x < 0){
                    player1Score++;
                }
                if(ballPos.x > 640){
                    player0Score++;
                }
                score = player0Score + "   :   " + player1Score;
                app.send({type: "score", score: score})

                ballPos =  {x:640/2,y: 480/2};
                ballVelocity = {x:ballSpeed,y:0};
                if(Math.floor( Math.random() * 2 ) == 1){
                    ballVelocity = {x:-ballSpeed,y:0};
                }
                ballVelocity.y = Math.random()*ballSpeed-ballSpeed/2;
            }
            if(hitPaddle()){
                ballVelocity.x = -ballVelocity.x;
                ballVelocity.y = Math.random()*2*ballSpeed-ballSpeed;
                ballPos = tempBallPos;
            }
            if(ballPos.y > 480 || ballPos.y <0){
                ballVelocity.y = -ballVelocity.y;
                ballPos = tempBallPos;
            }

            if(paddle0Pos != lastPaddle0Pos){
                lastPaddle0Pos = paddle0Pos;
                app.send({type:"paddle0Pos",pos:paddle0Pos});
            }

            if(lastBallPos.x != ballPos.x || lastBallPos.y != ballPos.y){
                app.send({type:"ballPos",pos:ballPos});
            }
        };

        var app = new App(key);
        app.on("connected",function(){
            console.log("connected with peer")
            canvas = document.createElement('canvas');
            canvas.width = 640;
            canvas.height = 480;
            ctx = canvas.getContext('2d');
            $(document.body).append(canvas);
            setInterval(run,1000/60);
        });
        app.on("disconnected",function(){
            console.log("disconnected with peer")
            $('.headerBar').fadeIn();
        });
        app.on("message",function(obj){
            if(obj.type == "paddle1Pos"){
                paddle1Pos = obj.pos;
            }
        });
        app.on("error",function(err){
            console.log(err);
        });
        app.host();
        window.prompt("Give this code to the other person",app.guid);
        $('.headerBar').fadeOut();
    };

    var startClient = function(){
        var run = function(){
            renderPong();
            if(Key.isDown(Key.DOWN_ARROW)){
                paddle1Pos += 2;
            }
            if(Key.isDown(Key.UP_ARROW)){
                paddle1Pos -= 2;
            }
            paddle1Pos = Math.max(paddle1Pos,0);
            paddle1Pos = Math.min(paddle1Pos,640);

            if(paddle1Pos != lastPaddle1Pos){
                lastPaddle1Pos = paddle1Pos;
                app.send({type:"paddle1Pos",pos:paddle1Pos});
            }
        };

        var app = new App(key);
        app.on("connected",function(){
            canvas = document.createElement('canvas');
            canvas.width = 640;
            canvas.height = 480;
            ctx = canvas.getContext('2d');
            $(document.body).append(canvas);
            console.log("connected with peer")
            setInterval(run,1000/60);
        })
        app.on("disconnected",function(){
            console.log("disconnected with peer")
            $('.headerBar').fadeIn();
        })
        app.on("message",function(obj){
            if(obj.type == "paddle0Pos"){
                paddle0Pos = obj.pos;
            }
            if(obj.type == "ballPos"){
                ballPos = obj.pos;
            }
            if(obj.type == "score"){
                score = obj.score;
            }
        })
        app.on("error",function(err){
            console.log(err);
        })
        app.join(window.prompt("Enter in game code"));
        $('.headerBar').fadeOut();
    };

    $('.buttonHost').click(startServer);
    $('.buttonJoin').click(startClient);
</script>
</div>
  </body>
</html>
